<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Oscillator Test</title>
</head>

<body>

    <table id="table">
        <tr id="trow-add">
            <td></td>
            <td></td>
            <td></td>
            <td>
                <input type="button" id="addBtn" value="+" />
                <input type="button" id="remBtn" value="-" />
                <input type="button" id="stopBtn" value="||" />
                <input type="button" id="playBtn" value=">" />
            </td>
        </tr>
    </table>

    
    <script>
        // Settings
        const lastRow = document.getElementById('trow-add');
        let rowCount = 0;
        const realValues = [];
        const imagValues = [];

        // Audio
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioCtx.createOscillator();
        let wave;
        oscillator.connect(audioCtx.destination);
        let hasAudioStarted = false;

        addRow();
        addRow();
        rebuildAudio();

        function addRow() {
            let newRow = document.createElement('tr');
            newRow.innerHTML = `
            <td><label for="in-real-${rowCount + 1}">R${rowCount + 1}</label></td>
            <td><input type="range" min="0" max="1" step="0.01" id="in-real-${rowCount + 1}" /></td>
            <td><label for="in-imag-${rowCount + 1}">I${rowCount + 1}</label></td>
            <td><input type="range" min="0" max="1" step="0.01" id="in-imag-${rowCount + 1}" /></td>
            `;
            rowCount++;
            lastRow.parentNode.insertBefore(newRow, lastRow);
            let realIn = document.getElementById(`in-real-${rowCount}`);
            realIn.addEventListener('change', () => onValueChanged(realIn.value, 'r', rowCount - 1));
            let imagIn = document.getElementById(`in-imag-${rowCount}`);
            imagIn.addEventListener('change', () => onValueChanged(imagIn.value, 'i', rowCount - 1));

            realValues.push(realIn.value);
            imagValues.push(imagIn.value);

            rebuildAudio();
        }

        function remRow() {
            if (rowCount <= 2)
                return;

            let toRemove = lastRow.previousSibling;
            toRemove.remove();

            realValues.splice(realValues.length - 1, 1);
            imagValues.splice(imagValues.length - 1, 1);
        }

        function onValueChanged(val, type, idx) {
            if (type === 'r') {
                realValues[idx] = val;
            }
            else {
                imagValues[idx] = val;
            }

            rebuildAudio();
        }

        function rebuildAudio() {
            if (realValues.length < 2)
                return;

            console.log("Rebuild " + realValues + " " + imagValues);
            let wave = audioCtx.createPeriodicWave(realValues, imagValues);
            oscillator.setPeriodicWave(wave);
        }

        function startAudio() {
            if (!hasAudioStarted) {
                hasAudioStarted = true;
                oscillator.start();
            }
            else {
                oscillator.connect(audioCtx.destination);
            }
        }
        
        function stopAudio() {
            oscillator.disconnect();
        }
        
        document.getElementById('addBtn').addEventListener('click', addRow);
        document.getElementById('remBtn').addEventListener('click', remRow);
        document.getElementById('playBtn').addEventListener('click', startAudio);
        document.getElementById('stopBtn').addEventListener('click', stopAudio);
    </script>
</body>

</html>